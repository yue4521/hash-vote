# .github/workflows/release.yml
name: Release
on:
  push:
    tags: ['v*.*.*']

permissions:
  id-token: write   # OIDC Áî®
  contents: write   # „Éê„ÉÉ„Ç∏Êõ¥Êñ∞Áî®

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: |
          python -m pip install --upgrade build
          python -m build
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  update-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Update README badge
        run: |
          sed -i "s/version-[^-]*-green/version-${{ steps.version.outputs.VERSION }}-green/g" README.md
      - name: Commit badge update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout test/workflow || git checkout main || git checkout master
          git add README.md
          git commit -m "docs: README„Éê„Éº„Ç∏„Éß„É≥„Çív${{ steps.version.outputs.VERSION }}„Å´Êõ¥Êñ∞

          ü§ñ Generated with [Claude Code](https://claude.ai/code)

          Co-Authored-By: Claude <noreply@anthropic.com>" || exit 0
          git push origin test/workflow || git push origin main || git push origin master

  publish:
    needs: [build, update-badge]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with: {name: dist, path: dist}
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1